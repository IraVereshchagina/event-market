<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Event Market - Interactive Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .dashboard { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 450px; text-align: center; }
        .counter-box { background: #ffebee; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .counter { font-size: 48px; color: #d32f2f; font-weight: bold; }
        .btn { background: #1976d2; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 10px; transition: 0.3s; }
        .btn:hover { background: #115293; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #2e7d32; }
        .btn-success:hover { background: #1b5e20; }
        .log { text-align: left; background: #222; color: #00ff00; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin-top: 20px;}
        .error { color: #ff5252; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2>üé∏ Rock Night Mega Concert</h2>
    <div id="connection-status" style="color: #666; font-size: 14px;">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...</div>

    <div class="counter-box">
        <div>–î–æ—Å—Ç—É–ø–Ω–æ –±–∏–ª–µ—Ç–æ–≤:</div>
        <div id="seats-counter" class="counter">---</div>
    </div>

    <button class="btn" onclick="apiCreateEvent()">1. –°–æ–∑–¥–∞—Ç—å –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
    <button class="btn" id="session-btn" onclick="apiCreateSession()" disabled>2. –û—Ç–∫—Ä—ã—Ç—å –ü—Ä–æ–¥–∞–∂–∏</button>
    <button class="btn btn-success" id="buy-btn" onclick="apiBuyTicket()" disabled>3. –ö—É–ø–∏—Ç—å –ë–∏–ª–µ—Ç</button>

    <div class="log" id="log-box"></div>
</div>

<script>
    const API_CATALOG = 'http://localhost:8082/api/v1';
    const API_BOOKING = 'http://localhost:8083/api/v1';
    let currentEventId = null;
    let currentSessionId = null;

    const socket = new SockJS('http://localhost:8085/ws');
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, function () {
        document.getElementById('connection-status').innerText = 'üü¢ WebSocket –ê–∫—Ç–∏–≤–µ–Ω';
        log("Connected to Notification Service.");
    });

    function subscribeToEvent(eventId) {
        stompClient.subscribe('/topic/events/' + eventId, function (message) {
            const data = JSON.parse(message.body);
            const counter = document.getElementById('seats-counter');
            counter.innerText = data.availableSeats;
            counter.style.color = '#2e7d32';
            setTimeout(() => counter.style.color = '#d32f2f', 500);
            log(`[WebSocket] Seats updated! Remaining: ${data.availableSeats}`);
        });
        log(`üéß Subscribed to real-time updates for Event ID: ${eventId}`);
    }

    async function apiCreateEvent() {
        log("‚è≥ Creating event in Catalog...");
        try {
            const randomId = Math.floor(Math.random() * 1000);
            const response = await fetch(`${API_CATALOG}/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: `Rock Night #${randomId}`, category: "CONCERT", date: "2026-05-10T19:00:00", city: "Moscow", price: 1000.00, capacity: 50 })
            });

            if (!response.ok) throw new Error("Catalog DB Error");

            const eventData = await response.json();
            currentEventId = eventData.id;
            log(`‚úÖ Event created successfully! DB ID: ${currentEventId}`);
            subscribeToEvent(currentEventId);
            document.getElementById('session-btn').disabled = false;
        } catch (e) { log(`<span class="error">‚ùå Error: ${e.message}</span>`); }
    }

    async function apiCreateSession() {
        log("‚è≥ Creating sales session...");
        try {
            const response = await fetch(`${API_BOOKING}/sessions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ eventId: currentEventId, capacity: 50, price: 1000.00 })
            });

            if (!response.ok) throw new Error("Booking DB Error");

            currentSessionId = await response.json();
            log(`‚úÖ Sales opened! DB Session ID: ${currentSessionId}.`);
            document.getElementById('seats-counter').innerText = 50;
            document.getElementById('buy-btn').disabled = false;
        } catch (e) { log(`<span class="error">‚ùå Error: ${e.message}</span>`); }
    }

    async function apiBuyTicket() {
            log("‚è≥ Booking ticket...");
            try {
                const response = await fetch(`${API_BOOKING}/booking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: 101, eventSessionId: currentSessionId })
                });

                if (!response.ok) throw new Error("Cannot book ticket");

                const data = await response.json();

                if (data.status === 'CANCELLED') {
                    log(`<span class="error">‚ùå Booking failed: SOLD OUT! No tickets left.</span>`);
                    return;
                }

                log(`‚úÖ Ticket Booked! ID: ${data.ticketId}. Status: ${data.status}`);
                log(`‚è≥ Waiting for payment (MockBank, 5s)...`);

                setTimeout(() => {
                    log(`üí∞ Payment SUCCESS! Ticket ${data.ticketId} is now PAID.`);
                }, 6000);
            } catch (e) { log(`<span class="error">‚ùå Error: ${e.message}</span>`); }
        }

    function log(message) {
        const logBox = document.getElementById('log-box');
        logBox.innerHTML += `> ${message}<br>`;
        logBox.scrollTop = logBox.scrollHeight;
    }
</script>
</body>
</html>